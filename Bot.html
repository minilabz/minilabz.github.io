<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fast Trade Bot</title>
  <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    function lastThrusday(year, month) {
      var lastDay = new Date(year, month, 0);
      if (lastDay.getDay() < 4) {
        lastDay.setDate(lastDay.getDate() - 7);
      }
      lastDay.setDate(lastDay.getDate() - (lastDay.getDay() - 4));
      return lastDay;
    }

    function firstThrusday(year, month) {
      var firstDay = new Date(year, month - 1, 1);
      if (firstDay.getDay() > 4) {
        firstDay.setDate(firstDay.getDate() + 7);
      }
      firstDay.setDate(firstDay.getDate() - (firstDay.getDay() - 4));
      return firstDay;
    }
  </script>
</head>

<body>
  <table class="table-fixed m-auto" id="msg">
    <thead>
      <tr class="text-xl">
        <th class="w-auto px-2 py-2 text-sm" title="Buy or Sell">
          <input type="checkbox" id="checkAll" checked />
        </th>

        <th class="w-auto px-2 py-2 text-sm" title="Buy or Sell">-</th>
        <th class="w-auto px-4 text-sm" title="Stock Symbol">Symbol</th>
        <th class="w-auto px-4 text-sm" title="Order Type">Order</th>
        <th class="w-auto px-4 text-sm">Qty</th>
        <th class="w-auto px-4 text-sm">Price</th>
        <th class="w-auto px-4 text-sm" title="Tif / Validity">Tif</th>
        <th class="w-auto px-4 text-sm" title="DISCLOSED QTY">Dis.Qty</th>
        <th class="w-auto px-4 text-sm" title="Complexity / Variety">Variety</th>
        <!-- <th class="w-auto px-4 text-sm" title="Position / Product">Position</th>
        <th class="w-auto px-4 text-sm" title="Trigger Price">Trigger</th>
        <th class="w-auto px-4 text-sm" title="Target BUY / SELL">Target</th>
        <th class="w-auto px-4 text-sm" title="Stop Loss - BUY / SELL">SL</th>
        <th class="w-auto px-4 text-sm" title="Trailing Stop Loss">Tri.SL</th> -->
        <th class="w-auto px-4 text-sm"> Send </th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr id="row">
        <td class="w-auto px-2 text-sm">
          <input type="checkbox" name="row" checked class="checkMe" />
        </td>
        <td>
          <label for="action" class="buysell select-none text-white px-4 py-2 rounded bg-green-400" value="B">Buy
          </label>
        </td>
        <td class="text-sm">
          <input type="search" class="bg-purple-white  p-2" placeholder="Search by Symbol..." />
        </td>
        <td class="text-sm">
          <select
            class="border-gray-300 rounded-md text-gray-600 h-10 pl-2 pr-2 bg-white hover:border-gray-400 focus:outline-none appearance-none">
            <option selected value="M" title="Market">M</option>
            <option value="L" title="Limit" disabled>L</option>
            <option value="SL" title="Stop Loss" disabled>SL</option>
            <option value="SLM" title="Stop Loss - Limit" disabled>SL-L</option>
          </select>
        </td>
        <td class="text-sm">
          <input type="number" min="1" max="999" class="bg-purple-white p-3 w-20" placeholder="100" value="10" />
        </td>
        <td class="text-sm">
          <input type="number" min="1" max="999" step="0.01" class="bg-purple-white p-3 w-20" placeholder="100.01"
            value="" />
        </td>
        <td class="px-4 text-sm">
          <select
            class="border-gray-300 rounded-md text-gray-600 h-10 pl-2 pr-2 bg-white hover:border-gray-400 focus:outline-none appearance-none">
            <option selected value="D" title="Day">D</option>
            <option value="I" title="IOC" disabled>I</option>
          </select>
        </td>

        <td class="px-4 text-sm">
          <input type="number" min="1" max="999" class="bg-purple-white p-3 w-20" placeholder="100" value="10" />
        </td>
        <td class="px-4 text-sm">
          <select
            class="border-gray-300 rounded-md text-gray-600 h-10 pl-2 pr-2 bg-white hover:border-gray-400 focus:outline-none appearance-none">
            <option selected value="S" title="Simple">S</option>
            <option value="A" title="AMO" disabled>AMO</option>
            <option value="CO" title="CO" disabled>CO</option>
            <option value="OC" title="OCO / BO" disabled>OCO</option>
          </select>
        </td>
        <!-- <td class="px-4 text-sm">
          <input type="text" class="bg-purple-white p-3 w-20 opacity-50 cursor-not-allowed" placeholder="100" />
        </td>
        <td class="px-4 text-sm">
          <input type="text" class="bg-purple-white p-3 w-20 opacity-50 cursor-not-allowed" placeholder="100" />
        </td>
        <td class="px-4 text-sm">
          <input type="text" class="bg-purple-white p-3 w-20 opacity-50 cursor-not-allowed" placeholder="100" />
        </td>
        <td class="px-4 text-sm">
          <input type="text" class="bg-purple-white p-3 w-20 opacity-50 cursor-not-allowed" placeholder="100" />
        </td>
        <td class="px-4 text-sm">
          <input type="text" class="bg-purple-white p-3 w-20 opacity-50 cursor-not-allowed" placeholder="100" />
        </td> -->
        <td class="px-4 text-sm">
          <button type="submit" class="py-2 px-4 rounded-2 border-indigo-500 border-2"
            onclick="javascript:;">Send</button>
        </td>
      </tr>
    </tbody>
  </table>
  <div class="flex items-center justify-center h-24">
    <div id="send" class="bg-indigo-800 text-white font-bold rounded-sm border shadow-lg px-5 py-4">
      Send
    </div>
  </div>

  <div id="msgTemp" class="m-auto border rounded-md flex flex-col px-4 py-4 space-y-4 text-gray-500 text-2xl hidden"
    style="width: 800px;height: 800px;">
    <div class="text-2xl px h-16 border text-indigo-900 text-center"> MyBillion Trade Master</div>
  </div>
  <script>
    let url = 'https://api.telegram.org/bot1071828300:AAHyJaaX-J56lV3KSSYvcqEc2RhFbuoxqR4/sendPhoto?chat_id=-1001256116935';
    let qs = "";
    let inline = (url) => {
      return {
        "inline_keyboard": [
          [
            { "text": "upstox", "url": "https://minilabz.github.io/Upstox.html?" + url },
            { "text": "zerodha", "url": "https://www.minilabz.com/Zerodha.html?" + url },
            { "text": "dailygong", "url": "https://www.minilabz.com/dailygong.html?" + url }
          ]
        ]
      }
    }

    function dataURItoFile(dataURI) {

      var byteString = atob(dataURI.split(',')[1]);

      // separate out the mime component
      var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

      // write the bytes of the string to an ArrayBuffer
      var ab = new ArrayBuffer(byteString.length);
      var ia = new Uint8Array(ab);
      for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      return new Blob([ab], { type: mimeString });
    }

    function sendData(url, dataURI, qs) {
      const formData = new FormData();
      formData.append("chat_id", "-1001256116935");
      // formData.append("caption", "upstox : https://minilabz.github.io/Upstox.html \nzerodha : https://www.minilabz.com/Zerodha.html\ndailygong : https://www.minilabz.com/dailygong.html");
      formData.append("photo", dataURItoFile(dataURI));
      formData.append("reply_markup", JSON.stringify(inline(qs)));
      const response = fetch(url, {
        method: 'POST',
        body: formData
      });
      response.then(alert('Done'));
    }

    var $msg = document.getElementById("msgTemp");
    var $send = document.getElementById("send");
    var $checkAll = document.getElementById("checkAll");
    var $row = document.getElementById("row");
    var $rows = document.getElementById("rows");

    for (var rowindx = 1; rowindx < 10; rowindx++) {
      $copy = $row.cloneNode(true);
      window.$copy = $copy;
      $action = $copy.getElementsByClassName("buysell")[0];
      $action.setAttribute("id", "action" + rowindx);
      $rows.appendChild($copy);
    }

    var $buysell = document.getElementsByClassName("buysell");

    for (var indx = 0; indx < $buysell.length; indx++) {
      $buysell[indx].onclick = (e) => {
        if (e.target.innerText.trim() === "Buy") {
          e.target.classList.add("bg-red-400");
          e.target.classList.remove("bg-green-400");
          e.target.innerText = "Sell"

        } else {
          e.target.classList.add("bg-green-400");
          e.target.classList.remove("bg-red-400");
          e.target.innerText = "Buy"
        }
      }
    }


    $checkAll.onclick = function () {
      var $checkMe = document.getElementsByClassName("checkMe");
      console.log($checkMe);
      for (var indx = 0; indx < $checkMe.length; indx++) {
        $checkMe[indx].checked = checkAll.checked
      }
    }

    $send.onclick = function () {
      // if ($msg.childNodes.length > 0) {
      //   for (var indx = 0; indx < $msg.childNodes.length; indx++) {
      //     $msg.removeChild($msg.childNodes[indx])
      //   }
      // }
      $msg.innerHTML="";

      qs = [];
      console.log($rows.children.length);
      var rows = []
      for (ridx = 0; ridx < $rows.children.length; ridx++) {
        var $tr = $rows.children[ridx];
        var row = [];
        var qsl = []
        if (!$tr.children[0].children[0].checked)
          continue;
        for (cidx = 1; cidx < $tr.children.length - 1; cidx++) {
          var $td = $tr.children[cidx];
          if (cidx == 1) {
            row.push($td.innerHTML);
            console.log($td.innerHTML)
            qsl.push($td.innerText);
          }
          else {
            var value = $td.children[0].value ? $td.children[0].value : "-";
            row.push(value);

            qsl.push(value);
          }
        }
        console.log(row.join("|"));
        var tr = document.createElement('div');
        tr.classList.add("text-2xl")
        tr.innerHTML = row.join(" | ");
        $msg.appendChild(tr);
        qs.push(qsl.join("|"));
        rows.push(row);
      }
      $msg.classList.toggle("hidden");
      html2canvas($msg).then(canvas => {
        $msg.classList.toggle("hidden");
        let screenshot = canvas.toDataURL();
        sendData(url, screenshot, qs.join("||"));

      });
    }
  </script>
</body>

</html>